<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ¡Œé¢é—¹é’Ÿ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="app">
    <div class="usage-tips" id="usage-tips">
      <div class="tips-content">
        <h3>ä½¿ç”¨æç¤º</h3>
        <p>1. è¯·åœ¨æ’ä»¶åº”ç”¨è®¾ç½®ä¸­å°†æ’ä»¶è®¾ä¸ºã€Œè·Ÿéšä¸»ç¨‹åºåŒæ—¶å¯åŠ¨è¿è¡Œã€</p>
        <p>2. é€€å‡ºæ—¶ä¸è¦å…³é—­æ’ä»¶ï¼Œä½¿ç”¨ESCé”®å°†æ’ä»¶é€€å‡ºåˆ°åå°è¿è¡Œ</p>
      </div>
      <button class="tips-close" onclick="document.getElementById('usage-tips').style.display='none'">Ã—</button>
    </div>
    <h2>æ¡Œé¢é—¹é’Ÿ</h2>
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('timeline')">æ—¶é—´è½´</button>
      <button class="tab-button" onclick="switchTab('input')">åˆ›å»ºæ—¶é—´å—</button>
      <button class="tab-button" onclick="switchTab('settings')">å‚æ•°è®¾ç½®</button>
    </div>

    <div id="timeline-tab" class="tab-content active">
      <div class="timeline">
        <div class="timeline-blocks" id="timeline-blocks"></div>
      </div>
      <div id="current-task" class="current-task">å½“å‰æ— ä»»åŠ¡</div>
    </div>

    <div id="input-tab" class="tab-content">
      <div class="input-container">
        <div class="form-input">
          <label>ä»»åŠ¡åç§°</label>
          <input type="text" id="task-name" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
        </div>
        <div class="form-input">
          <label>æ—¶é—´ç‚¹</label>
          <input type="time" id="task-time" value="09:00">
        </div>
        <div class="form-input">
          <label>å¯ç”¨çŠ¶æ€</label>
          <select id="task-enabled">
            <option value="true">å¯ç”¨</option>
            <option value="false">ç¦ç”¨</option>
          </select>
        </div>
        <div class="form-input">
          <label>é¢„æé†’</label>
          <select id="task-pre-alert">
            <option value="true">å¯ç”¨</option>
            <option value="false">ç¦ç”¨</option>
          </select>
        </div>
        <div class="form-input">
          <label>æé†’æ¬¡æ•°</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="number" id="task-reminder-count" min="1" max="999" placeholder="è¾“å…¥æ¬¡æ•°" style="width: 80px; min-width: 60px;">
            <label style="margin: 0; white-space: nowrap;">
              <input type="checkbox" id="task-reminder-permanent"> æ°¸ä¹…æé†’
            </label>
          </div>
          <small style="color: #666; font-size: 12px;">æ°¸ä¹…æé†’ï¼šæ¯å¤©éƒ½ä¼šæé†’ï¼›æŒ‡å®šæ¬¡æ•°ï¼šæé†’å®Œæˆåè‡ªåŠ¨ç¦ç”¨</small>
        </div>
        <div class="form-actions" style="margin-top: 15px;">
          <button class="alert-button primary" onclick="handleFormSubmit()">ä¿å­˜</button>
        </div>
        <div class="time-block-list" id="time-block-list"></div>
      </div>
    </div>

    <div id="settings-tab" class="tab-content">
      <div class="input-container">
        <div class="avatar-preview">
          <label>å¤´åƒè®¾ç½®</label>
          <button class="alert-button primary" onclick="window.handleAvatarUpload()">é€‰æ‹©å¤´åƒ</button>
          <img id="avatarPreview" onerror="this.src='./logo.svg'">
        </div>
        <div class="form-input">
          <label>é¢„æé†’æå‰æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
          <input type="number" id="pre-alert-time" min="1" max="10" value="1" onchange="handlePreAlertTimeChange()">
        </div>
        <div class="form-input">
          <label>é¢„æé†’æ¬¡æ•°</label>
          <input type="number" id="pre-alert-count" disabled>
        </div>
        <div class="form-input">
          <label>å…¨å±€æé†’å¼€å…³(å½“ç¦ç”¨æ—¶æ‰€æœ‰æé†’éƒ½å°†ä¸èƒ½æé†’)</label>
          <select id="global-alert-toggle" onchange="handlePreAlertTimeChange()">
            <option value="true">å¯ç”¨</option>
            <option value="false">ç¦ç”¨</option>
          </select>
        </div>
      </div>
    </div>
    
    
  </div>

  <div class="alert-overlay" id="alert-overlay">
    <div class="alert-content">
      <h3 id="alert-title"></h3>
      <p id="alert-message"></p>
      <div class="alert-actions">
        <button class="alert-button primary" onclick="handleAlertAction('complete')">å®Œæˆ</button>
        <button class="alert-button secondary" onclick="handleAlertAction('delay')">å»¶è¿Ÿ10åˆ†é’Ÿ</button>
      </div>
    </div>
  </div>

  <div class="side-alert" id="side-alert">
    <p id="side-alert-message"></p>
  </div>



  <script>
    // æ˜¾ç¤ºè¡¨å•æç¤º
    function showFormAlert(title, message) {
      const overlay = document.getElementById('alert-overlay');
      const alertTitle = document.getElementById('alert-title');
      const alertMessage = document.getElementById('alert-message');
      const alertActions = document.querySelector('.alert-actions');
      
      alertTitle.textContent = title;
      alertMessage.textContent = message;
      
      // ä¿®æ”¹æŒ‰é’®
      alertActions.innerHTML = `
        <button class="alert-button primary" onclick="document.getElementById('alert-overlay').style.display = 'none'">ç¡®å®š</button>
      `;
      
      overlay.style.display = 'flex';
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`${tabId}-tab`).classList.add('active');
      document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');
    }



    // æ¸²æŸ“æ—¶é—´è½´
    function renderTimeline() {
      const container = document.getElementById('timeline-blocks');
      const timeBlocks = window.getTimeSettings();
      container.innerHTML = '';
      
      // æŒ‰æ—¶é—´æ’åºï¼ˆæŒ‰å°æ—¶å’Œåˆ†é’Ÿï¼‰
      timeBlocks.sort((a, b) => {
        const timeA = new Date(a.startTime);
        const timeB = new Date(b.startTime);
        const hoursA = timeA.getHours();
        const minutesA = timeA.getMinutes();
        const hoursB = timeB.getHours();
        const minutesB = timeB.getMinutes();
        
        // å…ˆæŒ‰å°æ—¶æ’åºï¼Œå†æŒ‰åˆ†é’Ÿæ’åº
        if (hoursA !== hoursB) {
          return hoursA - hoursB;
        }
        return minutesA - minutesB;
      });
      
      timeBlocks.forEach(block => {
        const blockStartTime = new Date(block.startTime);
        const blockEl = document.createElement('div');
        blockEl.className = 'timeline-block';
        blockEl.style.background = block.color;
        blockEl.style.margin = '10px 0';
        blockEl.style.padding = '10px';
        blockEl.style.borderRadius = '4px';
        blockEl.style.cursor = 'pointer';
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const blockTime = blockStartTime.getHours() * 60 + blockStartTime.getMinutes();
        
        // æ‰¾åˆ°å½“å‰æ—¶é—´ä¹‹å‰æœ€è¿‘çš„ä»»åŠ¡ä½œä¸ºæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const enabledBlocks = timeBlocks.filter(b => b.enabled);
        const pastBlocks = enabledBlocks.filter(b => {
          const bTime = new Date(b.startTime);
          const bTimeMinutes = bTime.getHours() * 60 + bTime.getMinutes();
          return bTimeMinutes <= currentTime;
        });
        
        let currentTaskBlock = null;
        if (pastBlocks.length > 0) {
          // æ‰¾åˆ°æ—¶é—´æœ€æ¥è¿‘å½“å‰æ—¶é—´çš„å·²è¿‡å»ä»»åŠ¡
          currentTaskBlock = pastBlocks.reduce((latest, current) => {
            const latestTime = new Date(latest.startTime);
            const currentTimeBlock = new Date(current.startTime);
            const latestMinutes = latestTime.getHours() * 60 + latestTime.getMinutes();
            const currentMinutes = currentTimeBlock.getHours() * 60 + currentTimeBlock.getMinutes();
            return currentMinutes > latestMinutes ? current : latest;
          });
        }
        
        const isCurrentTask = currentTaskBlock && currentTaskBlock.id === block.id;
        
        // æ˜¾ç¤ºæ—¶é—´å’Œä»»åŠ¡åç§°
        const timeStr = blockStartTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        // å…¼å®¹æ€§å¤„ç†ï¼šä¸ºæ—§æ•°æ®è®¾ç½®é»˜è®¤å€¼
        const reminderCount = block.reminderCount !== undefined ? block.reminderCount : -1;
        const remainingCount = block.remainingCount !== undefined ? block.remainingCount : reminderCount;
        const reminderText = reminderCount === -1 ? 'æ°¸ä¹…' : `å‰©ä½™${remainingCount}æ¬¡`;
        
        // ä¸ºå½“å‰ä»»åŠ¡æ·»åŠ ç‰¹æ®Šæ ‡è¯†
        const currentTaskIndicator = isCurrentTask ? '<span style="color: #ff4444; font-weight: bold; margin-left: 10px;">ğŸ”¥ è¿›è¡Œä¸­</span>' : '';
        
        blockEl.innerHTML = `
          <div style="font-weight: bold; font-size: 16px">${timeStr}${currentTaskIndicator}</div>
          <div style="margin: 5px 0">${block.task}</div>
          <div style="font-size: 12px; color: #666">
            ${block.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
            é¢„æé†’ï¼š${block.preAlert ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
            æé†’ï¼š${reminderText}
          </div>
        `;
        
        // æ ¹æ®çŠ¶æ€è®¾ç½®æ ·å¼
        if (!block.enabled) {
          blockEl.style.opacity = '0.5';
        }
        
        // ä¸ºå½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡æ·»åŠ ç‰¹æ®Šæ ·å¼
        if (isCurrentTask) {
          blockEl.classList.add('current-task');
          blockEl.style.border = '3px solid #ff4444';
          blockEl.style.boxShadow = '0 0 15px rgba(255, 68, 68, 0.3)';
          blockEl.style.transform = 'scale(1.02)';
          blockEl.style.zIndex = '10';
        }
        
        blockEl.onclick = () => {
          console.log('æ—¶é—´å—ç‚¹å‡»äº‹ä»¶è§¦å‘:', block);
          window.alertManager.startTimeBlock(block);
        };

        container.appendChild(blockEl);
      });
    }

    // å¤„ç†æé†’æ“ä½œ
    function handleAlertAction(action) {
      window.alertManager.handleAction(action);
      renderTimeline();
    }
    // æ¸²æŸ“æ—¶é—´å—åˆ—è¡¨
    function renderTimeBlockList() {
      const container = document.getElementById('time-block-list');
      const timeBlocks = window.getTimeSettings();
      
      container.innerHTML = timeBlocks.map(block => {
        const date = new Date(block.startTime);
        const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const blockTime = date.getHours() * 60 + date.getMinutes();
        
        // æ‰¾åˆ°å½“å‰æ—¶é—´ä¹‹å‰æœ€è¿‘çš„ä»»åŠ¡ä½œä¸ºæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const enabledBlocks = timeBlocks.filter(b => b.enabled);
        const pastBlocks = enabledBlocks.filter(b => {
          const bTime = new Date(b.startTime);
          const bTimeMinutes = bTime.getHours() * 60 + bTime.getMinutes();
          return bTimeMinutes <= currentTime;
        });
        
        let currentTaskBlock = null;
        if (pastBlocks.length > 0) {
          // æ‰¾åˆ°æ—¶é—´æœ€æ¥è¿‘å½“å‰æ—¶é—´çš„å·²è¿‡å»ä»»åŠ¡
          currentTaskBlock = pastBlocks.reduce((latest, current) => {
            const latestTime = new Date(latest.startTime);
            const currentTimeBlock = new Date(current.startTime);
            const latestMinutes = latestTime.getHours() * 60 + latestTime.getMinutes();
            const currentMinutes = currentTimeBlock.getHours() * 60 + currentTimeBlock.getMinutes();
            return currentMinutes > latestMinutes ? current : latest;
          });
        }
        
        const isCurrentTask = currentTaskBlock && currentTaskBlock.id === block.id;
        
        // ä¸ºå½“å‰ä»»åŠ¡æ·»åŠ ç‰¹æ®Šæ ·å¼ç±»å’Œæ ‡è¯†
        const currentTaskClass = isCurrentTask ? ' current-task' : '';
        const currentTaskIndicator = isCurrentTask ? ' ğŸ”¥ è¿›è¡Œä¸­' : '';
        
        return `
          <div class="time-block-item${currentTaskClass}" data-id="${block.id}">
            <div class="time-block-info">
              <div class="time-block-color" style="background: ${block.color}"></div>
              <div class="time-block-details">
                <strong>${block.task}${currentTaskIndicator}</strong>
                <span>${timeStr}</span>
                <span class="status-indicator">
                  ${block.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
                  é¢„æé†’ï¼š${block.preAlert ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
                  æé†’ï¼š${(block.reminderCount !== undefined ? block.reminderCount : -1) === -1 ? 'æ°¸ä¹…' : `å‰©ä½™${block.remainingCount !== undefined ? block.remainingCount : (block.reminderCount !== undefined ? block.reminderCount : -1)}æ¬¡`}
                </span>
              </div>
            </div>
            <div class="time-block-actions">
              <button class="edit" onclick="editTimeBlock('${block.id}')">ç¼–è¾‘</button>
              <button class="delete" onclick="removeTimeBlock('${block.id}')">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ç¼–è¾‘æ—¶é—´å—
    function editTimeBlock(id) {
      const timeBlocks = window.getTimeSettings();
      const block = timeBlocks.find(b => b.id === id);
      if (!block) return;

      const date = new Date(block.startTime);
      const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

      document.getElementById('task-name').value = block.task;
      document.getElementById('task-time').value = timeStr;
      document.getElementById('task-enabled').value = block.enabled ? 'true' : 'false';
      document.getElementById('task-pre-alert').value = block.preAlert ? 'true' : 'false';
      
      // è®¾ç½®æé†’æ¬¡æ•°
      if (block.reminderCount === -1) {
        document.getElementById('task-reminder-permanent').checked = true;
        document.getElementById('task-reminder-count').value = '';
      } else {
        document.getElementById('task-reminder-permanent').checked = false;
        document.getElementById('task-reminder-count').value = block.reminderCount || '';
      }
      
      window.currentEditingBlockId = id;
      
      // åˆ‡æ¢åˆ°è¡¨å•è¾“å…¥æ¨¡å¼
      switchTab('input');
    }

    // åˆ é™¤æ—¶é—´å—
    function removeTimeBlock(id) {
      // åˆ é™¤æ•°æ®å¹¶æ›´æ–°ç•Œé¢
      window.deleteTimeBlock(id);
      
      // æ›´æ–°ç•Œé¢
      renderTimeBlockList();
      renderTimeline();
      
      // æ¸…ç©ºè¡¨å•
      window.currentEditingBlockId = null;
      const taskNameInput = document.getElementById('task-name');
      const taskTimeInput = document.getElementById('task-time');
      
      if (taskNameInput) taskNameInput.value = '';
      if (taskTimeInput) taskTimeInput.value = '09:00';
      document.getElementById('task-enabled').value = 'true';
      document.getElementById('task-pre-alert').value = 'true';
      document.getElementById('task-reminder-count').value = '';
      document.getElementById('task-reminder-permanent').checked = false;
    }

    // å¤„ç†å¯è§†åŒ–è¡¨å•æäº¤
    function handleFormSubmit() {
      const taskName = document.getElementById('task-name').value.trim();
      const taskTime = document.getElementById('task-time').value.trim();
      const enabled = document.getElementById('task-enabled').value === 'true';
      const preAlert = document.getElementById('task-pre-alert').value === 'true';
      const reminderCount = document.getElementById('task-reminder-count').value.trim();
      const reminderPermanent = document.getElementById('task-reminder-permanent').checked;

      // è¡¨å•éªŒè¯
      if (!taskName) {
        alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
        return;
      }
      if (!taskTime || !/^\d{1,2}:\d{2}$/.test(taskTime)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æ—¶é—´æ ¼å¼ï¼ˆå¦‚ï¼š09:00ï¼‰');
        return;
      }
      
      // æé†’æ¬¡æ•°éªŒè¯
      if (!reminderPermanent && (!reminderCount || isNaN(reminderCount) || parseInt(reminderCount) < 1)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æé†’æ¬¡æ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰æˆ–é€‰æ‹©æ°¸ä¹…æé†’');
        return;
      }

      const [hours, minutes] = taskTime.split(':').map(Number);
      if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´èŒƒå›´ï¼ˆ00:00-23:59ï¼‰');
        return;
      }

      const blocks = window.getTimeSettings();
      const newBlock = {
        task: taskName,
        startTime: new Date().setHours(hours, minutes, 0, 0),
        enabled,
        preAlert,
        reminderCount: reminderPermanent ? -1 : parseInt(reminderCount),
        remainingCount: reminderPermanent ? -1 : parseInt(reminderCount),
        color: getRandomColor()
      };

      if (window.currentEditingBlockId) {
        // æ›´æ–°ç°æœ‰æ—¶é—´å—
        if (window.updateTimeBlock(window.currentEditingBlockId, newBlock)) {
          window.currentEditingBlockId = null;
        }
      } else {
        // æ·»åŠ æ–°æ—¶é—´å—
        blocks.push(newBlock);
        window.saveTimeSettings(blocks);
      }

      renderTimeline();
      renderTimeBlockList();
      document.getElementById('task-name').value = '';
      document.getElementById('task-time').value = '09:00';
      document.getElementById('task-enabled').value = 'true';
      document.getElementById('task-pre-alert').value = 'true';
      document.getElementById('task-reminder-count').value = '';
      document.getElementById('task-reminder-permanent').checked = false;
    }



    // è·å–éšæœºé¢œè‰²
    function getRandomColor() {
      const colors = ['#1890ff', '#52c41a', '#faad14', '#f5222d', '#722ed1'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
      renderTimeline();
      renderTimeBlockList();
      
      // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ç•Œé¢ï¼Œç¡®ä¿å½“å‰ä»»åŠ¡é«˜äº®çŠ¶æ€å®æ—¶æ›´æ–°
      setInterval(() => {
        renderTimeline();
        renderTimeBlockList();
      }, 60000); // 60ç§’åˆ·æ–°ä¸€æ¬¡
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('app').style.display = 'block';
      // æ·»åŠ è°ƒè¯•ä¿¡æ¯
      console.log('DOMåŠ è½½å®Œæˆ');
      console.log('getTimeSettingså­˜åœ¨:', !!window.getTimeSettings);
      console.log('alertManagerå­˜åœ¨:', !!window.alertManager);
  
      
      // æ£€æŸ¥æ˜¯å¦åœ¨uToolsç¯å¢ƒä¸­
      const isInUTools = window.utools !== undefined;
      console.log('æ˜¯å¦åœ¨uToolsç¯å¢ƒä¸­:', isInUTools);
      
      // å¦‚æœä¸åœ¨uToolsç¯å¢ƒä¸­ï¼Œæä¾›æ¨¡æ‹Ÿæ•°æ®ç”¨äºæµ‹è¯•
      if (!isInUTools) {
        console.log('éuToolsç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
        window.getTimeSettings = window.getTimeSettings || function() {
          return [
            {
              task: 'æµ‹è¯•ä»»åŠ¡1',
              startTime: new Date().setHours(10, 0, 0, 0),
              color: '#1890ff',
              enabled: true,
              status: 'pending',
              duration: 30,
              id: 'test1'
            },
            {
              task: 'æµ‹è¯•ä»»åŠ¡2',
              startTime: new Date().setHours(14, 0, 0, 0),
              color: '#52c41a',
              enabled: true,
              status: 'pending',
              duration: 45,
              id: 'test2'
            }
          ];
        };
        
        window.alertManager = window.alertManager || {
          startTimeBlock: function(block) {
            alert('å¼€å§‹ä»»åŠ¡: ' + block.task);
          },
          handleAction: function(action) {
            console.log('æ‰§è¡Œæ“ä½œ:', action);
          }
        };
      }
      
      if (window.getTimeSettings && window.alertManager) {
        initApp();
      } else {
        console.error('åˆå§‹åŒ–å¤±è´¥: getTimeSettingsæˆ–alertManageræœªå®šä¹‰');
      }
    });
  </script>
</body>
</html>