<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ¡Œé¢é—¹é’Ÿ</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="./script.js" data-website-id="a2db7bef-b5fc-4fcf-8b1a-998a8b197cc3" data-host-url="http://106.53.170.171:3000/"></script>
</head>
<body>
  <div id="app">
    <div class="usage-tips" id="usage-tips">
      <div class="tips-content">
        <h3>ä½¿ç”¨æç¤º</h3>
        <p>1. è¯·åœ¨æ’ä»¶åº”ç”¨è®¾ç½®ä¸­å°†æ’ä»¶è®¾ä¸ºã€Œè·Ÿéšä¸»ç¨‹åºåŒæ—¶å¯åŠ¨è¿è¡Œã€</p>
        <p>2. é€€å‡ºæ—¶ä¸è¦å…³é—­æ’ä»¶ï¼Œä½¿ç”¨ESCé”®å°†æ’ä»¶é€€å‡ºåˆ°åå°è¿è¡Œ</p>
      </div>
      <button class="tips-close" onclick="document.getElementById('usage-tips').style.display='none'">Ã—</button>
    </div>
    <h2>æ¡Œé¢é—¹é’Ÿ</h2>
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('timeline')">æ—¶é—´è½´</button>
      <button class="tab-button" onclick="switchTab('input')">åˆ›å»ºæ—¶é—´å—</button>
      <button class="tab-button" onclick="switchTab('settings')">å‚æ•°è®¾ç½®</button>
    </div>

    <div id="timeline-tab" class="tab-content active">
      <!-- å½“å‰ä»»åŠ¡å¿«é€Ÿæ˜¾ç¤ºåŒºåŸŸ -->
      <div class="current-task-header" id="current-task-header">
        <div class="current-task-info">
          <div class="current-task-label">å½“å‰ä»»åŠ¡</div>
          <div class="current-task-content" id="current-task-content">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡</div>
          <div class="current-task-time" id="current-task-time"></div>
        </div>
        <div class="next-task-info" id="next-task-info" style="display: none;">
          <div class="next-task-label">ä¸‹ä¸€ä¸ªä»»åŠ¡</div>
          <div class="next-task-content" id="next-task-content"></div>
          <div class="next-task-time" id="next-task-time"></div>
        </div>
      </div>
      
      <div class="timeline">
        <div class="timeline-blocks" id="timeline-blocks"></div>
      </div>
      <div id="current-task" class="current-task" style="display: none;">å½“å‰æ— ä»»åŠ¡</div>
    </div>

    <div id="input-tab" class="tab-content">
      <div class="input-container">
        <div class="form-input">
          <label>ä»»åŠ¡åç§°</label>
          <input type="text" id="task-name" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
        </div>
        <div class="form-input">
          <label>æ—¶é—´ç‚¹</label>
          <input type="time" id="task-time" value="09:00">
        </div>
        <div class="form-input">
          <label>å¯ç”¨çŠ¶æ€</label>
          <select id="task-enabled">
            <option value="true">å¯ç”¨</option>
            <option value="false">ç¦ç”¨</option>
          </select>
        </div>
        <div class="form-input">
          <label>é¢„æé†’</label>
          <select id="task-pre-alert">
            <option value="true">å¯ç”¨</option>
            <option value="false">ç¦ç”¨</option>
          </select>
        </div>
        <div class="form-input">
          <label>æé†’æ¨¡å¼</label>
          <select id="task-reminder-mode" onchange="toggleWeekdaySelector()">
            <option value="daily">æ¯å¤©æé†’</option>
            <option value="weekly">æŒ‰æ˜ŸæœŸæé†’</option>
          </select>
        </div>
        <div class="form-input" id="weekday-selector" style="display: none;">
          <label>é€‰æ‹©æ˜ŸæœŸ</label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
            <label style="margin: 0; display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" id="weekday-1" value="1"> å‘¨ä¸€
            </label>
            <label style="margin: 0; display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" id="weekday-2" value="2"> å‘¨äºŒ
            </label>
            <label style="margin: 0; display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" id="weekday-3" value="3"> å‘¨ä¸‰
            </label>
            <label style="margin: 0; display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" id="weekday-4" value="4"> å‘¨å››
            </label>
            <label style="margin: 0; display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" id="weekday-5" value="5"> å‘¨äº”
            </label>
            <label style="margin: 0; display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" id="weekday-6" value="6"> å‘¨å…­
            </label>
            <label style="margin: 0; display: flex; align-items: center; gap: 4px; font-size: 12px;">
              <input type="checkbox" id="weekday-0" value="0"> å‘¨æ—¥
            </label>
          </div>
          <small style="color: #666; font-size: 12px;">è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ˜ŸæœŸ</small>
        </div>
        <div class="form-input">
          <label>æé†’æ¬¡æ•°</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="number" id="task-reminder-count" min="1" max="999" placeholder="è¾“å…¥æ¬¡æ•°" style="width: 80px; min-width: 60px;">
            <label style="margin: 0; white-space: nowrap;">
              <input type="checkbox" id="task-reminder-permanent"> æ°¸ä¹…æé†’
            </label>
          </div>
          <small style="color: #666; font-size: 12px;">æ°¸ä¹…æé†’ï¼šæ¯å¤©éƒ½ä¼šæé†’ï¼›æŒ‡å®šæ¬¡æ•°ï¼šæé†’å®Œæˆåè‡ªåŠ¨ç¦ç”¨</small>
        </div>
        <div class="form-actions" style="margin-top: 15px;">
          <button class="alert-button primary" onclick="handleFormSubmit()">ä¿å­˜</button>
        </div>
        <div class="time-block-list" id="time-block-list"></div>
      </div>
    </div>

    <div id="settings-tab" class="tab-content">
      <div class="input-container">
        <div class="avatar-preview">
          <label>å¤´åƒè®¾ç½®</label>
          <button class="alert-button primary" onclick="window.handleAvatarUpload()">é€‰æ‹©å¤´åƒ</button>
          <img id="avatarPreview" onerror="this.src='./logo.svg'">
        </div>
        <div class="form-input">
          <label>é¢„æé†’æå‰æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
          <input type="number" id="pre-alert-time" min="1" max="10" value="1" onchange="handlePreAlertTimeChange()">
        </div>
        <div class="form-input">
          <label>é¢„æé†’æ¬¡æ•°</label>
          <input type="number" id="pre-alert-count" disabled>
        </div>
        <div class="form-input">
          <label>å…¨å±€æé†’å¼€å…³(å½“ç¦ç”¨æ—¶æ‰€æœ‰æé†’éƒ½å°†ä¸èƒ½æé†’)</label>
          <select id="global-alert-toggle" onchange="handlePreAlertTimeChange()">
            <option value="true">å¯ç”¨</option>
            <option value="false">ç¦ç”¨</option>
          </select>
        </div>
        <div class="form-input">
          <label>æé†’æ–¹å¼</label>
          <div style="padding: 8px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; color: #495057;">
            å¼¹çª—é€šçŸ¥ï¼ˆå¼ºåˆ¶æé†’ï¼‰
          </div>
          <small style="color: #666; font-size: 12px;">
            é—¹é’Ÿé‡‡ç”¨å¼¹çª—é€šçŸ¥æ–¹å¼ï¼Œç¡®ä¿é‡è¦æé†’ä¸ä¼šè¢«é—æ¼
          </small>
        </div>
        <div class="form-input">
          <label>é“ƒå£°è®¾ç½®</label>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; gap: 10px; align-items: center;">
              <button class="alert-button primary" onclick="window.handleBellSoundUpload()">é€‰æ‹©è‡ªå®šä¹‰é“ƒå£°</button>
              <button class="alert-button secondary" onclick="window.resetToDefaultBellSound()">ä½¿ç”¨é»˜è®¤é“ƒå£°</button>
              <button class="alert-button secondary" onclick="testBellSound()">æµ‹è¯•é“ƒå£°</button>
            </div>
            <div id="bell-sound-status" style="font-size: 12px; color: #666;">å½“å‰: é»˜è®¤é“ƒå£°</div>
            <small style="color: #666; font-size: 12px;">æ”¯æŒ MP3ã€WAVã€OGGã€M4Aã€AAC æ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶</small>
          </div>
        </div>
        

      </div>
    </div>
    
    
  </div>

  <div class="alert-overlay" id="alert-overlay">
    <div class="alert-content">
      <h3 id="alert-title"></h3>
      <p id="alert-message"></p>
      <div class="alert-actions">
        <button class="alert-button primary" onclick="handleAlertAction('complete')">å®Œæˆ</button>
        <button class="alert-button secondary" onclick="handleAlertAction('delay')">å»¶è¿Ÿ10åˆ†é’Ÿ</button>
      </div>
    </div>
  </div>

  <div class="side-alert" id="side-alert">
    <p id="side-alert-message"></p>
  </div>

  <!-- è½»é‡çº§æ“ä½œæç¤º -->
  <div class="toast-notification" id="toast-notification">
    <div class="toast-content">
      <span class="toast-icon">âœ“</span>
      <span class="toast-message" id="toast-message"></span>
    </div>
  </div>



  <script>
    // æ˜¾ç¤ºè¡¨å•æç¤º
    function showFormAlert(title, message) {
      const overlay = document.getElementById('alert-overlay');
      const alertTitle = document.getElementById('alert-title');
      const alertMessage = document.getElementById('alert-message');
      const alertActions = document.querySelector('.alert-actions');
      
      alertTitle.textContent = title;
      alertMessage.textContent = message;
      
      // ä¿®æ”¹æŒ‰é’®
      alertActions.innerHTML = `
        <button class="alert-button primary" onclick="document.getElementById('alert-overlay').style.display = 'none'">ç¡®å®š</button>
      `;
      
      overlay.style.display = 'flex';
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`${tabId}-tab`).classList.add('active');
      document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');
    }

    // åˆ‡æ¢æ˜ŸæœŸé€‰æ‹©å™¨æ˜¾ç¤º/éšè—
    function toggleWeekdaySelector() {
      const reminderMode = document.getElementById('task-reminder-mode').value;
      const weekdaySelector = document.getElementById('weekday-selector');
      
      if (reminderMode === 'weekly') {
        weekdaySelector.style.display = 'block';
      } else {
        weekdaySelector.style.display = 'none';
        // æ¸…ç©ºæ˜ŸæœŸé€‰æ‹©
        document.querySelectorAll('[id^="weekday-"]').forEach(checkbox => {
          checkbox.checked = false;
        });
      }
    }





    // æ¸²æŸ“æ—¶é—´è½´
    function renderTimeline() {
      const container = document.getElementById('timeline-blocks');
      const timeBlocks = window.getTimeSettings();
      container.innerHTML = '';
      
      // æŒ‰æ—¶é—´æ’åºï¼ˆæŒ‰å°æ—¶å’Œåˆ†é’Ÿï¼‰
      timeBlocks.sort((a, b) => {
        const timeA = new Date(a.startTime);
        const timeB = new Date(b.startTime);
        const hoursA = timeA.getHours();
        const minutesA = timeA.getMinutes();
        const hoursB = timeB.getHours();
        const minutesB = timeB.getMinutes();
        
        // å…ˆæŒ‰å°æ—¶æ’åºï¼Œå†æŒ‰åˆ†é’Ÿæ’åº
        if (hoursA !== hoursB) {
          return hoursA - hoursB;
        }
        return minutesA - minutesB;
      });
      
      timeBlocks.forEach(block => {
        const blockStartTime = new Date(block.startTime);
        const blockEl = document.createElement('div');
        blockEl.className = 'timeline-block';
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const blockTime = blockStartTime.getHours() * 60 + blockStartTime.getMinutes();
        
        // æ‰¾åˆ°å½“å‰æ—¶é—´ä¹‹å‰æœ€è¿‘çš„ä»»åŠ¡ä½œä¸ºæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const enabledBlocks = timeBlocks.filter(b => {
          if (!b.enabled) return false;
          
          // æ£€æŸ¥æ˜ŸæœŸæé†’æ¨¡å¼
          const reminderMode = b.reminderMode || 'daily';
          if (reminderMode === 'weekly') {
            const currentWeekday = now.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
            const weekdays = b.weekdays || [];
            return weekdays.includes(currentWeekday); // åªæœ‰ä»Šå¤©åœ¨é€‰å®šæ˜ŸæœŸå†…æ‰è€ƒè™‘
          }
          return true; // æ¯æ—¥æé†’æ¨¡å¼
        });
        
        const pastBlocks = enabledBlocks.filter(b => {
          const bTime = new Date(b.startTime);
          const bTimeMinutes = bTime.getHours() * 60 + bTime.getMinutes();
          return bTimeMinutes <= currentTime;
        });
        
        let currentTaskBlock = null;
        if (pastBlocks.length > 0) {
          // æ‰¾åˆ°æ—¶é—´æœ€æ¥è¿‘å½“å‰æ—¶é—´çš„å·²è¿‡å»ä»»åŠ¡
          currentTaskBlock = pastBlocks.reduce((latest, current) => {
            const latestTime = new Date(latest.startTime);
            const currentTimeBlock = new Date(current.startTime);
            const latestMinutes = latestTime.getHours() * 60 + latestTime.getMinutes();
            const currentMinutes = currentTimeBlock.getHours() * 60 + currentTimeBlock.getMinutes();
            return currentMinutes > latestMinutes ? current : latest;
          });
        }
        
        const isCurrentTask = currentTaskBlock && currentTaskBlock.id === block.id;
        
        // æ˜¾ç¤ºæ—¶é—´å’Œä»»åŠ¡åç§°
        const timeStr = blockStartTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        // å…¼å®¹æ€§å¤„ç†ï¼šä¸ºæ—§æ•°æ®è®¾ç½®é»˜è®¤å€¼
        const reminderCount = block.reminderCount !== undefined ? block.reminderCount : -1;
        const remainingCount = block.remainingCount !== undefined ? block.remainingCount : reminderCount;
        const reminderText = reminderCount === -1 ? 'æ°¸ä¹…' : `å‰©ä½™${remainingCount}æ¬¡`;
        
        // è·å–æé†’æ¨¡å¼ä¿¡æ¯
        const reminderMode = block.reminderMode || 'daily';
        let reminderModeText = 'æ¯æ—¥';
        if (reminderMode === 'weekly') {
          const weekdays = block.weekdays || [];
          const weekNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
          const selectedDays = weekdays.map(day => weekNames[day]).join('ã€');
          reminderModeText = `æ¯å‘¨(${selectedDays})`;
        }
        
        // æ„å»ºæ–°çš„æ ‘çŠ¶æ—¶é—´è½´HTMLç»“æ„
         blockEl.innerHTML = `
           <div class="timeline-content">
             <div class="timeline-color-indicator" style="background: ${block.color}"></div>
             <div class="timeline-text">
               <div class="timeline-header">
                 <div class="timeline-time">${timeStr}</div>
                 <div class="timeline-task">${block.task}</div>
               </div>
               <div class="timeline-status">
                 ${block.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
                 é¢„æé†’ï¼š${block.preAlert ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
                 æé†’ï¼š${reminderText} | 
                 æ¨¡å¼ï¼š${reminderModeText}
               </div>
               ${isCurrentTask ? '<div class="timeline-current-indicator">ğŸ”¥ è¿›è¡Œä¸­</div>' : ''}
             </div>
           </div>
         `;
        
        // æ ¹æ®çŠ¶æ€è®¾ç½®æ ·å¼ç±»
        if (!block.enabled) {
          blockEl.classList.add('disabled');
        }
        
        // ä¸ºå½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡æ·»åŠ ç‰¹æ®Šæ ·å¼
        if (isCurrentTask) {
          blockEl.classList.add('current-task');
        }
        
        blockEl.onclick = () => {
          const logger = window.logger || { log: console.log.bind(console) };
          logger.log('æ—¶é—´å—ç‚¹å‡»äº‹ä»¶è§¦å‘:', block);
          window.alertManager.startTimeBlock(block);
        };

        container.appendChild(blockEl);
      });
      
      // æ›´æ–°å½“å‰ä»»åŠ¡å¤´éƒ¨æ˜¾ç¤º
      updateCurrentTaskHeader(timeBlocks);
    }

    /**
     * æ›´æ–°å½“å‰ä»»åŠ¡å¤´éƒ¨æ˜¾ç¤ºåŒºåŸŸ
     * @param {Array} timeBlocks - æ—¶é—´å—æ•°ç»„
     * @date 2024-01-20
     */
    function updateCurrentTaskHeader(timeBlocks) {
      const currentTaskContent = document.getElementById('current-task-content');
      const currentTaskTime = document.getElementById('current-task-time');
      const nextTaskInfo = document.getElementById('next-task-info');
      const nextTaskContent = document.getElementById('next-task-content');
      const nextTaskTime = document.getElementById('next-task-time');
      
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      // æ‰¾åˆ°å½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
      const enabledBlocks = timeBlocks.filter(b => {
        if (!b.enabled) return false;
        
        // æ£€æŸ¥æ˜ŸæœŸæé†’æ¨¡å¼
        const reminderMode = b.reminderMode || 'daily';
        if (reminderMode === 'weekly') {
          const currentWeekday = now.getDay();
          const weekdays = b.weekdays || [];
          return weekdays.includes(currentWeekday);
        }
        return true;
      });
      
      const pastBlocks = enabledBlocks.filter(b => {
        const bTime = new Date(b.startTime);
        const bTimeMinutes = bTime.getHours() * 60 + bTime.getMinutes();
        return bTimeMinutes <= currentTime;
      });
      
      let currentTaskBlock = null;
      if (pastBlocks.length > 0) {
        currentTaskBlock = pastBlocks.reduce((latest, current) => {
          const latestTime = new Date(latest.startTime);
          const currentTimeBlock = new Date(current.startTime);
          const latestMinutes = latestTime.getHours() * 60 + latestTime.getMinutes();
          const currentMinutes = currentTimeBlock.getHours() * 60 + currentTimeBlock.getMinutes();
          return currentMinutes > latestMinutes ? current : latest;
        });
      }
      
      // æ‰¾åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡
      const futureBlocks = enabledBlocks.filter(b => {
        const bTime = new Date(b.startTime);
        const bTimeMinutes = bTime.getHours() * 60 + bTime.getMinutes();
        return bTimeMinutes > currentTime;
      });
      
      let nextTaskBlock = null;
      if (futureBlocks.length > 0) {
        nextTaskBlock = futureBlocks.reduce((earliest, current) => {
          const earliestTime = new Date(earliest.startTime);
          const currentTimeBlock = new Date(current.startTime);
          const earliestMinutes = earliestTime.getHours() * 60 + earliestTime.getMinutes();
          const currentMinutes = currentTimeBlock.getHours() * 60 + currentTimeBlock.getMinutes();
          return currentMinutes < earliestMinutes ? current : earliest;
        });
      }
      
      // æ›´æ–°å½“å‰ä»»åŠ¡æ˜¾ç¤º
      if (currentTaskBlock) {
        const startTime = new Date(currentTaskBlock.startTime);
        const timeStr = startTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        const elapsed = Math.floor((currentTime - (startTime.getHours() * 60 + startTime.getMinutes())));
        
        currentTaskContent.textContent = currentTaskBlock.task;
        currentTaskTime.textContent = `${timeStr} å¼€å§‹ (å·²è¿›è¡Œ ${elapsed} åˆ†é’Ÿ)`;
      } else {
        currentTaskContent.textContent = 'æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡';
        currentTaskTime.textContent = '';
      }
      
      // æ›´æ–°ä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¾ç¤º
      if (nextTaskBlock) {
        const startTime = new Date(nextTaskBlock.startTime);
        const timeStr = startTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        const remaining = (startTime.getHours() * 60 + startTime.getMinutes()) - currentTime;
        
        nextTaskContent.textContent = nextTaskBlock.task;
        nextTaskTime.textContent = `${timeStr} å¼€å§‹ (è¿˜æœ‰ ${remaining} åˆ†é’Ÿ)`;
        nextTaskInfo.style.display = 'block';
      } else {
        nextTaskInfo.style.display = 'none';
      }
    }

    // å¤„ç†æé†’æ“ä½œ
    function handleAlertAction(action) {
      window.alertManager.handleAction(action);
      renderTimeline();
    }
    // æ¸²æŸ“æ—¶é—´å—åˆ—è¡¨
    function renderTimeBlockList() {
      const container = document.getElementById('time-block-list');
      const timeBlocks = window.getTimeSettings();
      
      container.innerHTML = timeBlocks.map(block => {
        const date = new Date(block.startTime);
        const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const blockTime = date.getHours() * 60 + date.getMinutes();
        
        // æ‰¾åˆ°å½“å‰æ—¶é—´ä¹‹å‰æœ€è¿‘çš„ä»»åŠ¡ä½œä¸ºæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        const enabledBlocks = timeBlocks.filter(b => {
          if (!b.enabled) return false;
          
          // æ£€æŸ¥æ˜ŸæœŸæé†’æ¨¡å¼
          const reminderMode = b.reminderMode || 'daily';
          if (reminderMode === 'weekly') {
            const currentWeekday = now.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
            const weekdays = b.weekdays || [];
            return weekdays.includes(currentWeekday); // åªæœ‰ä»Šå¤©åœ¨é€‰å®šæ˜ŸæœŸå†…æ‰è€ƒè™‘
          }
          return true; // æ¯æ—¥æé†’æ¨¡å¼
        });
        
        const pastBlocks = enabledBlocks.filter(b => {
          const bTime = new Date(b.startTime);
          const bTimeMinutes = bTime.getHours() * 60 + bTime.getMinutes();
          return bTimeMinutes <= currentTime;
        });
        
        let currentTaskBlock = null;
        if (pastBlocks.length > 0) {
          // æ‰¾åˆ°æ—¶é—´æœ€æ¥è¿‘å½“å‰æ—¶é—´çš„å·²è¿‡å»ä»»åŠ¡
          currentTaskBlock = pastBlocks.reduce((latest, current) => {
            const latestTime = new Date(latest.startTime);
            const currentTimeBlock = new Date(current.startTime);
            const latestMinutes = latestTime.getHours() * 60 + latestTime.getMinutes();
            const currentMinutes = currentTimeBlock.getHours() * 60 + currentTimeBlock.getMinutes();
            return currentMinutes > latestMinutes ? current : latest;
          });
        }
        
        const isCurrentTask = currentTaskBlock && currentTaskBlock.id === block.id;
        
        // ä¸ºå½“å‰ä»»åŠ¡æ·»åŠ ç‰¹æ®Šæ ·å¼ç±»å’Œæ ‡è¯†
        const currentTaskClass = isCurrentTask ? ' current-task' : '';
        const currentTaskIndicator = isCurrentTask ? ' ğŸ”¥ è¿›è¡Œä¸­' : '';
        
        return `
          <div class="time-block-item${currentTaskClass}" data-id="${block.id}">
            <div class="time-block-info">
              <div class="time-block-color" style="background: ${block.color}"></div>
              <div class="time-block-details">
                <strong>${block.task}${currentTaskIndicator}</strong>
                <span>${timeStr}</span>
                <span class="status-indicator">
                  ${block.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
                  é¢„æé†’ï¼š${block.preAlert ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'} | 
                  æé†’ï¼š${(block.reminderCount !== undefined ? block.reminderCount : -1) === -1 ? 'æ°¸ä¹…' : `å‰©ä½™${block.remainingCount !== undefined ? block.remainingCount : (block.reminderCount !== undefined ? block.reminderCount : -1)}æ¬¡`} | 
                  æ¨¡å¼ï¼š${(() => {
                    const mode = block.reminderMode || 'daily';
                    if (mode === 'daily') return 'æ¯æ—¥';
                    if (mode === 'weekly') {
                      const weekdays = block.weekdays || [];
                      const weekNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                      const selectedDays = weekdays.map(day => weekNames[day]).join('ã€');
                      return `æ¯å‘¨(${selectedDays})`;
                    }
                    return mode;
                  })()}
                </span>
              </div>
            </div>
            <div class="time-block-actions">
              <button class="edit" onclick="editTimeBlock('${block.id}')">ç¼–è¾‘</button>
              <button class="delete" onclick="removeTimeBlock('${block.id}')">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ç¼–è¾‘æ—¶é—´å—
    function editTimeBlock(id) {
      const timeBlocks = window.getTimeSettings();
      const block = timeBlocks.find(b => b.id === id);
      if (!block) return;

      const date = new Date(block.startTime);
      const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

      document.getElementById('task-name').value = block.task;
      document.getElementById('task-time').value = timeStr;
      document.getElementById('task-enabled').value = block.enabled ? 'true' : 'false';
      document.getElementById('task-pre-alert').value = block.preAlert ? 'true' : 'false';
      
      // è®¾ç½®æé†’æ¬¡æ•°
      if (block.reminderCount === -1) {
        document.getElementById('task-reminder-permanent').checked = true;
        document.getElementById('task-reminder-count').value = '';
      } else {
        document.getElementById('task-reminder-permanent').checked = false;
        document.getElementById('task-reminder-count').value = block.reminderCount || '';
      }
      
      // è®¾ç½®æé†’æ¨¡å¼å’Œæ˜ŸæœŸé€‰æ‹©
      const reminderMode = block.reminderMode || 'daily';
      document.getElementById('task-reminder-mode').value = reminderMode;
      
      // æ¸…ç©ºæ‰€æœ‰æ˜ŸæœŸé€‰æ‹©
      document.querySelectorAll('[id^="weekday-"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // å¦‚æœæ˜¯æ˜ŸæœŸæé†’æ¨¡å¼ï¼Œå›å¡«é€‰ä¸­çš„æ˜ŸæœŸ
      if (reminderMode === 'weekly' && block.weekdays && block.weekdays.length > 0) {
        block.weekdays.forEach(day => {
          const checkbox = document.getElementById(`weekday-${day}`);
          if (checkbox) {
            checkbox.checked = true;
          }
        });
      }
      
      toggleWeekdaySelector();
      window.currentEditingBlockId = id;
      
      // åˆ‡æ¢åˆ°è¡¨å•è¾“å…¥æ¨¡å¼
      switchTab('input');
    }

    // åˆ é™¤æ—¶é—´å—
    function removeTimeBlock(id) {
      // åˆ é™¤æ•°æ®å¹¶æ›´æ–°ç•Œé¢
      window.deleteTimeBlock(id);
      
      // æ›´æ–°ç•Œé¢
      renderTimeBlockList();
      renderTimeline();
      
      // æ¸…ç©ºè¡¨å•
      window.currentEditingBlockId = null;
      const taskNameInput = document.getElementById('task-name');
      const taskTimeInput = document.getElementById('task-time');
      
      if (taskNameInput) taskNameInput.value = '';
      if (taskTimeInput) taskTimeInput.value = '09:00';
      document.getElementById('task-enabled').value = 'true';
      document.getElementById('task-pre-alert').value = 'true';
      document.getElementById('task-reminder-count').value = '';
      document.getElementById('task-reminder-permanent').checked = false;
    }

    // å¤„ç†å¯è§†åŒ–è¡¨å•æäº¤
    function handleFormSubmit() {
      const taskName = document.getElementById('task-name').value.trim();
      const taskTime = document.getElementById('task-time').value.trim();
      const enabled = document.getElementById('task-enabled').value === 'true';
      const preAlert = document.getElementById('task-pre-alert').value === 'true';
      const reminderCount = document.getElementById('task-reminder-count').value.trim();
      const reminderPermanent = document.getElementById('task-reminder-permanent').checked;
      const reminderMode = document.getElementById('task-reminder-mode').value;

      // è¡¨å•éªŒè¯
      if (!taskName) {
        alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
        return;
      }
      if (!taskTime || !/^\d{1,2}:\d{2}$/.test(taskTime)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æ—¶é—´æ ¼å¼ï¼ˆå¦‚ï¼š09:00ï¼‰');
        return;
      }
      
      // æé†’æ¬¡æ•°éªŒè¯
      if (!reminderPermanent && (!reminderCount || isNaN(reminderCount) || parseInt(reminderCount) < 1)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æé†’æ¬¡æ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰æˆ–é€‰æ‹©æ°¸ä¹…æé†’');
        return;
      }

      // æ˜ŸæœŸæé†’éªŒè¯
      let weekdays = [];
      if (reminderMode === 'weekly') {
        const checkedWeekdays = document.querySelectorAll('[id^="weekday-"]:checked');
        if (checkedWeekdays.length === 0) {
          alert('æŒ‰æ˜ŸæœŸæé†’æ¨¡å¼ä¸‹ï¼Œè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ˜ŸæœŸ');
          return;
        }
        weekdays = Array.from(checkedWeekdays).map(cb => parseInt(cb.value));
      }

      const [hours, minutes] = taskTime.split(':').map(Number);
      if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´èŒƒå›´ï¼ˆ00:00-23:59ï¼‰');
        return;
      }

      const blocks = window.getTimeSettings();
      const newBlock = {
        task: taskName,
        startTime: new Date().setHours(hours, minutes, 0, 0),
        enabled,
        preAlert,
        reminderCount: reminderPermanent ? -1 : parseInt(reminderCount),
        remainingCount: reminderPermanent ? -1 : parseInt(reminderCount),
        reminderMode: reminderMode,
        weekdays: reminderMode === 'weekly' ? weekdays : [],
        color: getRandomColor()
      };

      if (window.currentEditingBlockId) {
        // æ›´æ–°ç°æœ‰æ—¶é—´å—
        if (window.updateTimeBlock(window.currentEditingBlockId, newBlock)) {
          window.currentEditingBlockId = null;
        }
      } else {
        // æ·»åŠ æ–°æ—¶é—´å—
        blocks.push(newBlock);
        window.saveTimeSettings(blocks);
      }

      renderTimeline();
      renderTimeBlockList();
      clearForm();
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm() {
      document.getElementById('task-name').value = '';
      document.getElementById('task-time').value = '09:00';
      document.getElementById('task-enabled').value = 'true';
      document.getElementById('task-pre-alert').value = 'true';
      document.getElementById('task-reminder-count').value = '';
      document.getElementById('task-reminder-permanent').checked = false;
      document.getElementById('task-reminder-mode').value = 'daily';
      document.querySelectorAll('[id^="weekday-"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      toggleWeekdaySelector();
    }



    // è·å–éšæœºé¢œè‰²
    function getRandomColor() {
      const colors = ['#1890ff', '#52c41a', '#faad14', '#f5222d', '#722ed1'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // æµ‹è¯•é“ƒå£°åŠŸèƒ½
    function testBellSound() {
      if (window.playBellSound) {
        window.playBellSound();
        showFormAlert('é“ƒå£°æµ‹è¯•', 'é“ƒå£°æ’­æ”¾å®Œæˆï¼å¦‚æœæ²¡æœ‰å¬åˆ°å£°éŸ³ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸéŸ³é‡è®¾ç½®ã€‚');
      } else {
        showFormAlert('é”™è¯¯', 'é“ƒå£°åŠŸèƒ½æœªåˆå§‹åŒ–ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢ã€‚');
      }
    }

    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
      renderTimeline();
      renderTimeBlockList();
      
      // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ç•Œé¢ï¼Œç¡®ä¿å½“å‰ä»»åŠ¡é«˜äº®çŠ¶æ€å®æ—¶æ›´æ–°
      setInterval(() => {
        renderTimeline();
        renderTimeBlockList();
      }, 60000); // 60ç§’åˆ·æ–°ä¸€æ¬¡
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('app').style.display = 'block';
      // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆå®‰å…¨æ£€æŸ¥æ—¥å¿—ç®¡ç†å™¨æ˜¯å¦å·²åŠ è½½ï¼‰
      const logger = window.logger || { log: console.log.bind(console), error: console.error.bind(console) };
      logger.log('DOMåŠ è½½å®Œæˆ');
      logger.log('getTimeSettingså­˜åœ¨:', !!window.getTimeSettings);
      logger.log('alertManagerå­˜åœ¨:', !!window.alertManager);
  
      
      // æ£€æŸ¥æ˜¯å¦åœ¨uToolsç¯å¢ƒä¸­
      const isInUTools = window.utools !== undefined;
      logger.log('æ˜¯å¦åœ¨uToolsç¯å¢ƒä¸­:', isInUTools);
      
      // å¦‚æœä¸åœ¨uToolsç¯å¢ƒä¸­ï¼Œæä¾›æ¨¡æ‹Ÿæ•°æ®ç”¨äºæµ‹è¯•
        if (!isInUTools) {
          logger.log('éuToolsç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
        window.getTimeSettings = window.getTimeSettings || function() {
          return [
            {
              task: 'æµ‹è¯•ä»»åŠ¡1',
              startTime: new Date().setHours(10, 0, 0, 0),
              color: '#1890ff',
              enabled: true,
              status: 'pending',
              duration: 30,
              id: 'test1'
            },
            {
              task: 'æµ‹è¯•ä»»åŠ¡2',
              startTime: new Date().setHours(14, 0, 0, 0),
              color: '#52c41a',
              enabled: true,
              status: 'pending',
              duration: 45,
              id: 'test2'
            }
          ];
        };
        
        window.alertManager = window.alertManager || {
          startTimeBlock: function(block) {
            alert('å¼€å§‹ä»»åŠ¡: ' + block.task);
          },
          handleAction: function(action) {
              logger.log('æ‰§è¡Œæ“ä½œ:', action);
            }
        };
      }
      
      if (window.getTimeSettings && window.alertManager) {
        initApp();
      } else {
          logger.error('åˆå§‹åŒ–å¤±è´¥: getTimeSettingsæˆ–alertManageræœªå®šä¹‰');
        }
    });
  </script>
</body>
</html>
